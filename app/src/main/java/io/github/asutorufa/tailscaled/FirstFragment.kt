package io.github.asutorufa.tailscaled

import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.content.IntentFilter
import android.content.res.ColorStateList
import android.graphics.Color
import android.os.Build
import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import androidx.core.content.ContextCompat
import androidx.fragment.app.Fragment
import io.github.asutorufa.tailscaled.databinding.FragmentFirstBinding

class FirstFragment : Fragment() {
    private var _binding: FragmentFirstBinding? = null
    private val binding get() = _binding!!
    
    // Receiver для обновления UI, когда сервис запускается/останавливается
    private val statusReceiver = object : BroadcastReceiver() {
        override fun onReceive(context: Context, intent: Intent) {
            when (intent.action) {
                "START" -> updateUiState(true)
                "STOP" -> updateUiState(false)
            }
        }
    }

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View {
        _binding = FragmentFirstBinding.inflate(inflater, container, false)
        return binding.root
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        // Навигация
        binding.cardLogs.setOnClickListener {
            startActivity(Intent(requireContext(), LogsActivity::class.java))
        }
        binding.cardSettings.setOnClickListener {
            startActivity(Intent(requireContext(), SettingsActivity::class.java))
        }

        // Кнопка Start/Stop
        binding.btnAction.setOnClickListener {
            val isRunning = ProxyState.isActualRunning()
            val intent = Intent(requireContext(), TailscaledService::class.java)
            
            if (isRunning) {
                // Если работает -> шлем команду STOP
                intent.action = "STOP_ACTION"
                requireContext().startService(intent)
                // UI обновится через receiver, но для отзывчивости можно сменить текст сразу
                binding.btnAction.isEnabled = false 
            } else {
                // Если не работает -> шлем команду START
                intent.action = "START_ACTION"
                requireContext().startForegroundService(intent)
                binding.btnAction.isEnabled = false
            }
        }
    }

    override fun onResume() {
        super.onResume()
        // Регистрируем ресивер
        val filter = IntentFilter().apply {
            addAction("START")
            addAction("STOP")
        }
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            requireContext().registerReceiver(statusReceiver, filter, Context.RECEIVER_EXPORTED)
        } else {
            requireContext().registerReceiver(statusReceiver, filter)
        }

        // Синхронизируем UI с реальным состоянием
        updateUiState(ProxyState.isActualRunning())
    }

    override fun onPause() {
        super.onPause()
        try {
            requireContext().unregisterReceiver(statusReceiver)
        } catch (e: Exception) {
            // ignore
        }
    }

private fun updateUiState(isRunning: Boolean) {
        binding.btnAction.isEnabled = true
        
        if (isRunning) {
            binding.statusText.text = getString(R.string.status_running)
            binding.btnAction.text = getString(R.string.action_stop)
            
            val colorGreen = ContextCompat.getColor(requireContext(), android.R.color.holo_green_light)
            binding.statusCard.setCardBackgroundColor(colorGreen)
            binding.statusIcon.setImageResource(R.drawable.ic_launcher_foreground) 
        } else {
            binding.statusText.text = getString(R.string.status_stopped)
            binding.btnAction.text = getString(R.string.action_start)
            
            val typedValue = android.util.TypedValue()
            requireContext().theme.resolveAttribute(com.google.android.material.R.attr.colorSurfaceContainerHigh, typedValue, true)
            binding.statusCard.setCardBackgroundColor(typedValue.data)
            binding.statusIcon.setImageResource(R.drawable.ic_launcher_foreground)
        }
    }

    override fun onDestroyView() {
        super.onDestroyView()
        _binding = null
    }
}